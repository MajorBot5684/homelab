<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Homelab Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="style.css" rel="stylesheet" />
  <script src="config.js"></script>
</head>
<body>
  <nav class="navbar navbar-dark sticky-top shadow-sm">
    <div class="container-fluid">
      <span class="navbar-brand mb-0 h1"><i class="bi bi-hdd-network me-2"></i>Homelab Dashboard</span>
      <div class="d-flex align-items-center gap-2">
        <div class="search-wrap input-group input-group-sm">
          <span class="input-group-text bg-transparent text-secondary border-secondary"><i class="bi bi-search"></i></span>
          <input id="searchInput" type="search" class="form-control bg-transparent text-light border-secondary" placeholder="Search name, IP, role, OS, tag… (Press /)" />
        </div>
        <div id="tagBar" class="d-none d-md-flex flex-wrap gap-1"></div>
        <button id="btnScan" class="btn btn-outline-warning btn-sm" title="Scan network"><i class="bi bi-radar me-1"></i>Scan</button>
        <button class="btn btn-outline-light btn-sm" data-bs-toggle="offcanvas" data-bs-target="#editorPanel" title="Edit config (JSON)"><i class="bi bi-pencil-square me-1"></i>Edit</button>
        <button id="btnExport" class="btn btn-outline-info btn-sm" title="Download config JSON"><i class="bi bi-download me-1"></i>Export</button>
        <label for="fileImport" class="btn btn-outline-success btn-sm mb-0" title="Import config JSON"><i class="bi bi-upload me-1"></i>Import</label>
        <input id="fileImport" type="file" accept="application/json" class="d-none" />
      </div>
    </div>
  </nav>

  <div id="discoverBanner" class="alert alert-dark border-secondary rounded-0 mb-0 d-none" role="alert">
    <div class="container d-flex justify-content-between align-items-center">
      <div><i class="bi bi-radar me-2"></i><strong>New devices detected</strong> on your LAN. Review & add them to your inventory.</div>
      <div class="d-flex gap-2">
        <button id="btnViewDiscoveries" class="btn btn-sm btn-outline-light"><i class="bi bi-list-ul me-1"></i>Review</button>
        <button id="btnDismissDiscoveries" class="btn btn-sm btn-outline-secondary">Dismiss</button>
      </div>
    </div>
  </div>

  <main class="container py-4">
    <section class="mb-4">
      <div class="diagram p-3 text-center">
        <img id="networkDiagram" src="images/network-diagram.png" class="img-fluid" alt="Network Diagram (edit images/network-diagram.png)" onerror="this.outerHTML='<div class=\'py-4 muted\'>Place your diagram at <code>images/network-diagram.png</code></div>'" />
      </div>
      <div class="mt-2 small muted">Update your diagram by replacing <code>images/network-diagram.png</code>. SVG/PNG recommended.</div>
    </section>

    <section id="grafanaSection" class="mb-4 d-none">
      <h2 class="group-title">Grafana</h2>
      <div class="row" id="grafanaRows"></div>
      <div class="small muted mt-2">Configure Grafana panels in <code>servers.json → grafana.panels</code>.</div>
    </section>

    <div id="dashboard"></div>

    <div class="footer pt-4 mt-4 border-top border-secondary small">
      <div class="d-flex justify-content-between flex-wrap gap-2">
        <div>
          <span class="me-3"><span class="status-dot dot-online"></span>Online</span>
          <span class="me-3"><span class="status-dot dot-offline"></span>Offline</span>
          <span><span class="status-dot dot-unknown"></span>Unknown</span>
        </div>
        <div>
          <span class="me-3">Press <span class="small-kbd">/</span> to focus search</span>
          <span>Config: <code>/api/servers</code> or local edits. Backend API: <code>/api/*</code></span>
        </div>
      </div>
    </div>
  </main>

  <!-- Offcanvas JSON Editor -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="editorPanel" aria-labelledby="editorLabel">
    <div class="offcanvas-header">
      <h5 id="editorLabel"><i class="bi bi-braces-asterisk me-2"></i>Edit Config (servers.json)</h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <div class="mb-2 text-secondary">Edit your configuration below. Changes apply live and are saved to <code>localStorage</code>. Use Export to download a JSON copy.</div>
      <textarea id="configEditor" class="form-control bg-dark text-light border-secondary"></textarea>
<div id="validationErrors" class="mt-2 small"></div>
<div class="mt-2 d-flex flex-wrap gap-2">
  <button id="btnInsertServer" class="btn btn-sm btn-outline-secondary">Insert Server Template</button>
  <button id="btnInsertGroup" class="btn btn-sm btn-outline-secondary">Insert Group Template</button>
</div>
      <div class="edit-tools mt-3 d-flex justify-content-between flex-wrap gap-2">
        <div>
          <button id="btnApply" class="btn btn-primary"><i class="bi bi-check2-circle me-1"></i>Apply</button>
          <button id="btnApplySave" class="btn btn-success"><i class="bi bi-save2 me-1"></i>Apply &amp; Save</button>
          <button id="btnBackupSave" class="btn btn-outline-success"><i class="bi bi-archive me-1"></i>Save &amp; Backup</button>
          <button id="btnRevert" class="btn btn-outline-warning"><i class="bi bi-arrow-counterclockwise me-1"></i>Revert to file</button>
          <button id="btnClearLocal" class="btn btn-outline-danger"><i class="bi bi-x-octagon me-1"></i>Clear Local Changes</button>
        </div>
        <div class="d-flex flex-column gap-2" style="min-width:300px">
          <div class="input-group input-group-sm">
            <span class="input-group-text bg-transparent text-secondary border-secondary"><i class="bi bi-key-fill"></i></span>
            <input id="apiKeyInput" type="password" class="form-control bg-transparent text-light border-secondary" placeholder="API key (X-API-KEY)" />
            <button id="btnSaveApiKey" class="btn btn-outline-info btn-sm">Save</button>
          </div>
          <div class="input-group input-group-sm">
            <span class="input-group-text bg-transparent text-secondary border-secondary"><i class="bi bi-shield-lock"></i></span>
            <input id="bearerInput" type="password" class="form-control bg-transparent text-light border-secondary" placeholder="Bearer token (Authorization)" />
            <button id="btnSaveBearer" class="btn btn-outline-info btn-sm">Save</button>
          </div>
        </div>
      </div>

      <hr class="border-secondary my-3" />
<div class="mb-2"><strong>Backups</strong> <button id="btnRefreshBackups" class="btn btn-sm btn-outline-light ms-2">Refresh</button></div>
<div id="backupList" class="list-group mb-3"></div>


      <div class="d-flex align-items-center gap-2 flex-wrap">
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" id="schedEnabled">
          <label class="form-check-label" for="schedEnabled">Scheduled Scan</label>
        </div>
        <input id="schedSubnet" class="form-control form-control-sm bg-transparent text-light border-secondary" style="max-width:180px" placeholder="192.168.0.0/24">
        <input id="schedInterval" type="number" min="1" class="form-control form-control-sm bg-transparent text-light border-secondary" style="max-width:120px" placeholder="Interval (min)">
        <input id="schedTopPorts" type="number" min="1" max="1000" class="form-control form-control-sm bg-transparent text-light border-secondary" style="max-width:140px" placeholder="Top ports (100)">
        <button id="btnSaveSchedule" class="btn btn-outline-warning btn-sm">Save Schedule</button>
      </div>
    </div>
  </div>

  <!-- Discovery Modal -->
  <div class="modal fade" id="discoveryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content" style="background:#0f1218; color:#e6e8ef; border:1px solid #232738;">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-radar me-2"></i>Discovered Devices</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="input-group mb-3">
            <span class="input-group-text bg-transparent text-secondary border-secondary">Subnet</span>
            <input id="scanSubnet" class="form-control bg-transparent text-light border-secondary" placeholder="192.168.0.0/24" />
            <button id="btnRunScan" class="btn btn-warning"><i class="bi bi-radar me-1"></i>Scan</button>
          </div>
          <div id="discoverList" class="list-group"></div>
        </div>
        <div class="modal-footer">
          <button id="btnApplyNowDiscoveries" type="button" class="btn btn-primary">Apply Now</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script id="servers-config" type="application/json">
  { "groups": [] }
  </script>

  <script src="script.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
